<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoBowl 2026 - Europe Quiz</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #008080 0%, #20b2aa 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
        }

        .start-screen {
            text-align: center;
        }

        .start-screen p {
            color: #4a5568;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .category-select {
            margin: 20px 0;
        }

        .category-select label {
            display: block;
            margin-bottom: 10px;
            color: #4a5568;
            font-weight: 600;
        }

        .category-select select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .progress-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s ease;
        }

        .question-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            color: #718096;
            font-size: 0.9rem;
        }

        .category-badge {
            background: #edf2f7;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            color: #667eea;
        }

        .question-text {
            font-size: 1.3rem;
            color: #2d3748;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            text-align: left;
        }

        .option:hover:not(.disabled) {
            border-color: #667eea;
            background: #eef2ff;
        }

        .option.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .option.correct {
            border-color: #48bb78;
            background: #f0fff4;
            color: #276749;
        }

        .option.incorrect {
            border-color: #f56565;
            background: #fff5f5;
            color: #c53030;
        }

        .option.disabled {
            cursor: default;
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
        }

        .feedback.correct {
            background: #f0fff4;
            color: #276749;
        }

        .feedback.incorrect {
            background: #fff5f5;
            color: #c53030;
        }

        .score-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .score-number {
            font-size: 4rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-label {
            color: #718096;
            font-size: 1.2rem;
        }

        .results-breakdown {
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .results-breakdown h3 {
            color: #2d3748;
            margin-bottom: 15px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .hidden {
            display: none;
        }

        .globe-emoji {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .nav-brand:hover {
            opacity: 0.8;
        }

        .nav-icon {
            font-size: 1.5rem;
        }

        .nav-title {
            font-weight: 700;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .nav-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background 0.2s, transform 0.2s;
        }

        .nav-btn:hover {
            background: #e53e3e;
            transform: translateY(-1px);
        }

        .nav-btn.hidden {
            display: none;
        }

        .lang-selector {
            display: flex;
            gap: 8px;
        }

        .lang-btn {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            text-decoration: none;
            color: #4a5568;
        }

        .lang-btn:hover {
            border-color: #667eea;
            background: #eef2ff;
        }

        .lang-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        /* Study Mode Styles */
        .study-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .study-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .nav-arrow {
            background: linear-gradient(135deg, #008080 0%, #20b2aa 100%);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }

        .nav-arrow:hover:not(:disabled) {
            transform: scale(1.1);
        }

        .nav-arrow:disabled {
            opacity: 0.4;
            cursor: default;
        }

        .study-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }

        .study-question {
            font-size: 1.2rem;
            color: #2d3748;
            margin: 20px 0 15px 0;
            line-height: 1.5;
        }

        .study-answer {
            font-size: 1.3rem;
            font-weight: 600;
            color: #008080;
            padding: 15px;
            background: #e6fffa;
            border-radius: 10px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Speaker Button Styles */
        .speak-btn {
            background: linear-gradient(135deg, #008080 0%, #20b2aa 100%);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-left: 10px;
            vertical-align: middle;
        }

        .speak-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 128, 128, 0.4);
        }

        .speak-btn:active {
            transform: scale(0.95);
        }

        .answer-with-audio {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        @media (max-width: 600px) {
            .card {
                padding: 20px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .question-text {
                font-size: 1.1rem;
            }

            .btn {
                padding: 12px 30px;
                font-size: 1rem;
            }

            .study-question {
                font-size: 1rem;
            }

            .study-answer {
                font-size: 1.1rem;
            }
        }

        /* Map Screen Styles */
        .map-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .map-info {
            background: #f7fafc;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 15px;
            text-align: center;
        }

        .selected-country {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .border-countries {
            color: #718096;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .border-countries strong {
            color: #4a5568;
        }

        .map-legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #4a5568;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid #2d3748;
        }

        .legend-color.selected {
            background: #667eea;
        }

        .legend-color.neighbor {
            background: #f6ad55;
        }

        .map-container {
            border-radius: 15px;
            overflow: hidden;
            height: 450px;
        }

        #europe-map {
            height: 100%;
            width: 100%;
            background: #a8d5e5;
        }

        .country-tooltip {
            background: rgba(45, 55, 72, 0.9);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        .leaflet-tooltip-left:before,
        .leaflet-tooltip-right:before {
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Bar -->
        <nav class="navbar" id="navbar">
            <div class="nav-brand" onclick="goHome()">
                <span class="nav-icon">üåç</span>
                <span class="nav-title">GeoBowl 2026</span>
            </div>
            <div class="lang-selector">
                <span class="lang-btn active">EN</span>
                <a href="index-fr.html" class="lang-btn">FR</a>
            </div>
            <button class="nav-btn hidden" id="exit-btn" onclick="confirmExit()">Exit Quiz</button>
        </nav>

        <div class="card">
            <!-- Start Screen -->
            <div id="start-screen" class="start-screen">
                <div class="globe-emoji">üåç</div>
                <h1>GeoBowl 2026</h1>
                <p class="subtitle">Europe Study Quiz</p>
                <p>Test your knowledge of European geography! This quiz covers capitals, countries, mountains, rivers, and interesting facts from the GeoBowl study packet.</p>

                <div class="category-select">
                    <label for="region">Filter by region:</label>
                    <select id="region">
                        <option value="all">All Regions</option>
                        <option value="northern">Northern Europe</option>
                        <option value="southern">Southern Europe</option>
                        <option value="eastern">Eastern Europe</option>
                        <option value="western">Western Europe</option>
                    </select>
                </div>

                <div class="category-select">
                    <label for="category">Choose a category:</label>
                    <select id="category">
                        <option value="all">All Categories (Mixed)</option>
                        <option value="capitals">Countries & Capitals</option>
                        <option value="geography">Geography & Bodies of Water</option>
                        <option value="mountains">Mountains & Landforms</option>
                        <option value="rivers">Rivers</option>
                        <option value="facts">Interesting Facts</option>
                        <option value="glossary">Glossary Terms</option>
                    </select>
                </div>

                <div class="category-select">
                    <label for="num-questions">Number of questions:</label>
                    <select id="num-questions">
                        <option value="10">10 Questions</option>
                        <option value="20">20 Questions</option>
                        <option value="30">30 Questions</option>
                        <option value="50">50 Questions</option>
                    </select>
                </div>

                <button class="btn" id="start-btn" onclick="startQuiz()" disabled>Loading Questions...</button>
                <button class="btn btn-secondary" id="study-btn" onclick="startStudyMode()" disabled>Study Mode</button>
                <button class="btn btn-secondary" id="map-btn" onclick="showMapScreen()">üó∫Ô∏è Map</button>
            </div>

            <!-- Quiz Screen -->
            <div id="quiz-screen" class="hidden">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>

                <div class="question-info">
                    <span id="question-counter">Question 1 of 10</span>
                    <span class="category-badge" id="category-badge">Capitals</span>
                </div>

                <div class="question-text" id="question-text"></div>

                <div class="options" id="options"></div>

                <div class="feedback hidden" id="feedback"></div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn hidden" id="next-btn" onclick="nextQuestion()">Next Question</button>
                </div>
            </div>

            <!-- Results Screen -->
            <div id="results-screen" class="hidden">
                <div class="globe-emoji">üèÜ</div>
                <h1>Quiz Complete!</h1>

                <div class="score-display">
                    <div class="score-number" id="final-score">0%</div>
                    <div class="score-label" id="score-text">0 out of 10 correct</div>
                </div>

                <div class="results-breakdown" id="results-breakdown">
                    <h3>Category Breakdown:</h3>
                </div>

                <div style="text-align: center;">
                    <button class="btn" onclick="restartQuiz()">Play Again</button>
                    <button class="btn btn-secondary" onclick="goHome()">Change Settings</button>
                </div>
            </div>

            <!-- Study Mode Screen -->
            <div id="study-screen" class="hidden">
                <div class="study-header">
                    <h1>Study Mode</h1>
                    <p class="subtitle" id="study-category-label">All Categories</p>
                </div>

                <div class="study-navigation">
                    <button class="nav-arrow" id="prev-study" onclick="prevStudyCard()">&larr;</button>
                    <span id="study-counter">1 of 100</span>
                    <button class="nav-arrow" id="next-study" onclick="nextStudyCard()">&rarr;</button>
                </div>

                <div class="study-card">
                    <span class="category-badge" id="study-card-category">Category</span>
                    <div class="study-question" id="study-question">Question text here?</div>
                    <div class="study-answer" id="study-answer">Answer text here</div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="goHome()">Back to Menu</button>
                </div>
            </div>

            <!-- Map Screen -->
            <div id="map-screen" class="hidden">
                <div class="map-header">
                    <h1>Europe Map</h1>
                    <p class="subtitle">Click a country to see its borders</p>
                </div>

                <div class="map-info" id="map-info">
                    <div class="selected-country" id="selected-country">Select a country</div>
                    <div class="border-countries" id="border-countries"></div>
                </div>

                <div class="map-legend">
                    <span class="legend-item"><span class="legend-color selected"></span> Selected</span>
                    <span class="legend-item"><span class="legend-color neighbor"></span> Borders</span>
                </div>

                <div class="map-container">
                    <div id="europe-map"></div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="goHome()">Back to Menu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Question database - loaded from external file
        let questions = {};
        let questionsLoaded = false;

        // Load questions from JSON file
        async function loadQuestions() {
            try {
                const response = await fetch('questions.json');
                questions = await response.json();
                questionsLoaded = true;
                document.getElementById('start-btn').disabled = false;
                document.getElementById('start-btn').textContent = 'Start Quiz';
                document.getElementById('study-btn').disabled = false;
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('start-btn').textContent = 'Error Loading Questions';
            }
        }

        // Load questions when page loads
        loadQuestions();

        // Audio pronunciation function
        function pronounceAnswer(text) {
            // Cancel any ongoing speech
            speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9; // Slightly slower for clarity
            speechSynthesis.speak(utterance);
        }

        // Game state
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let categoryScores = {};
        let selectedCategory = 'all';
        let selectedRegion = 'all';
        let numQuestions = 10;
        let answered = false;

        // Study mode state
        let studyQuestions = [];
        let studyIndex = 0;

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function getQuestions(category, num, region) {
            let pool = [];

            if (category === 'all') {
                for (let cat in questions) {
                    questions[cat].forEach(q => {
                        pool.push({ ...q, category: cat });
                    });
                }
            } else {
                questions[category].forEach(q => {
                    pool.push({ ...q, category: category });
                });
            }

            // Filter by region
            if (region !== 'all') {
                pool = pool.filter(q => q.region === region || q.region === 'all');
            }

            pool = shuffleArray(pool);
            return pool.slice(0, Math.min(num, pool.length));
        }

        function getCategoryLabel(cat) {
            const labels = {
                capitals: 'Capitals',
                geography: 'Geography',
                mountains: 'Mountains',
                rivers: 'Rivers',
                facts: 'Facts',
                glossary: 'Glossary'
            };
            return labels[cat] || cat;
        }

        function getRegionLabel(region) {
            const labels = {
                all: 'All Regions',
                northern: 'Northern Europe',
                southern: 'Southern Europe',
                eastern: 'Eastern Europe',
                western: 'Western Europe'
            };
            return labels[region] || region;
        }

        function startQuiz() {
            if (!questionsLoaded) {
                alert('Questions are still loading. Please wait.');
                return;
            }
            selectedCategory = document.getElementById('category').value;
            selectedRegion = document.getElementById('region').value;
            numQuestions = parseInt(document.getElementById('num-questions').value);

            currentQuestions = getQuestions(selectedCategory, numQuestions, selectedRegion);

            if (currentQuestions.length === 0) {
                alert('No questions found for the selected category and region combination. Please try different filters.');
                return;
            }
            currentQuestionIndex = 0;
            score = 0;
            categoryScores = {};

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('results-screen').classList.add('hidden');
            showExitButton();

            showQuestion();
        }

        function showQuestion() {
            answered = false;
            const question = currentQuestions[currentQuestionIndex];

            document.getElementById('question-counter').textContent =
                `Question ${currentQuestionIndex + 1} of ${currentQuestions.length}`;

            document.getElementById('progress-fill').style.width =
                `${((currentQuestionIndex) / currentQuestions.length) * 100}%`;

            document.getElementById('category-badge').textContent =
                getCategoryLabel(question.category);

            document.getElementById('question-text').textContent = question.q;

            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';

            const shuffledOptions = shuffleArray(question.options);

            shuffledOptions.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option';
                button.textContent = option;
                button.onclick = () => selectAnswer(option, button);
                optionsContainer.appendChild(button);
            });

            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
        }

        function selectAnswer(answer, button) {
            if (answered) return;
            answered = true;

            const question = currentQuestions[currentQuestionIndex];
            const correct = answer === question.a;

            // Update scores
            if (correct) {
                score++;
            }

            if (!categoryScores[question.category]) {
                categoryScores[question.category] = { correct: 0, total: 0 };
            }
            categoryScores[question.category].total++;
            if (correct) {
                categoryScores[question.category].correct++;
            }

            // Show feedback
            const options = document.querySelectorAll('.option');
            options.forEach(opt => {
                opt.classList.add('disabled');
                if (opt.textContent === question.a) {
                    opt.classList.add('correct');
                } else if (opt === button && !correct) {
                    opt.classList.add('incorrect');
                }
            });

            const feedback = document.getElementById('feedback');
            feedback.classList.remove('hidden', 'correct', 'incorrect');
            feedback.classList.add(correct ? 'correct' : 'incorrect');

            // Add speaker button for audio pronunciation
            const speakerBtn = `<button class="speak-btn" onclick="pronounceAnswer('${question.a.replace(/'/g, "\\'")}')">üîä</button>`;
            if (correct) {
                feedback.innerHTML = `Correct! ${speakerBtn}`;
            } else {
                feedback.innerHTML = `Incorrect. The answer is: ${question.a} ${speakerBtn}`;
            }

            document.getElementById('next-btn').classList.remove('hidden');
            document.getElementById('next-btn').textContent =
                currentQuestionIndex < currentQuestions.length - 1 ? 'Next Question' : 'See Results';
        }

        function nextQuestion() {
            currentQuestionIndex++;

            if (currentQuestionIndex < currentQuestions.length) {
                showQuestion();
            } else {
                showResults();
            }
        }

        function showResults() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');
            hideExitButton();

            const percentage = Math.round((score / currentQuestions.length) * 100);
            document.getElementById('final-score').textContent = `${percentage}%`;
            document.getElementById('score-text').textContent =
                `${score} out of ${currentQuestions.length} correct`;

            // Category breakdown
            const breakdown = document.getElementById('results-breakdown');
            breakdown.innerHTML = '<h3>Category Breakdown:</h3>';

            for (let cat in categoryScores) {
                const catData = categoryScores[cat];
                const catPercent = Math.round((catData.correct / catData.total) * 100);

                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `
                    <span>${getCategoryLabel(cat)}</span>
                    <span>${catData.correct}/${catData.total} (${catPercent}%)</span>
                `;
                breakdown.appendChild(item);
            }
        }

        function restartQuiz() {
            startQuiz();
        }

        function goHome() {
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('study-screen').classList.add('hidden');
            document.getElementById('map-screen').classList.add('hidden');
            document.getElementById('exit-btn').classList.add('hidden');
        }

        function confirmExit() {
            if (confirm('Are you sure you want to exit the quiz? Your progress will be lost.')) {
                goHome();
            }
        }

        function showExitButton() {
            document.getElementById('exit-btn').classList.remove('hidden');
        }

        function hideExitButton() {
            document.getElementById('exit-btn').classList.add('hidden');
        }

        // Study Mode Functions
        function startStudyMode() {
            if (!questionsLoaded) {
                alert('Questions are still loading. Please wait.');
                return;
            }

            selectedCategory = document.getElementById('category').value;
            selectedRegion = document.getElementById('region').value;
            studyQuestions = getQuestions(selectedCategory, 999, selectedRegion); // Get all questions
            studyIndex = 0;

            if (studyQuestions.length === 0) {
                alert('No questions found for the selected category and region combination. Please try different filters.');
                return;
            }

            const categoryLabels = {
                all: 'All Categories',
                capitals: 'Countries & Capitals',
                geography: 'Geography & Bodies of Water',
                mountains: 'Mountains & Landforms',
                rivers: 'Rivers',
                facts: 'Interesting Facts',
                glossary: 'Glossary Terms'
            };

            let label = categoryLabels[selectedCategory];
            if (selectedRegion !== 'all') {
                label += ' - ' + getRegionLabel(selectedRegion);
            }
            document.getElementById('study-category-label').textContent = label;

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('study-screen').classList.remove('hidden');

            showStudyCard();
        }

        function showStudyCard() {
            const question = studyQuestions[studyIndex];

            document.getElementById('study-counter').textContent =
                `${studyIndex + 1} of ${studyQuestions.length}`;

            document.getElementById('study-card-category').textContent =
                getCategoryLabel(question.category);

            document.getElementById('study-question').textContent = question.q;

            // Add answer with speaker button
            const answerEl = document.getElementById('study-answer');
            const speakerBtn = `<button class="speak-btn" onclick="pronounceAnswer('${question.a.replace(/'/g, "\\'")}')">üîä</button>`;
            answerEl.innerHTML = `<span>${question.a}</span> ${speakerBtn}`;

            // Update navigation buttons
            document.getElementById('prev-study').disabled = studyIndex === 0;
            document.getElementById('next-study').disabled = studyIndex === studyQuestions.length - 1;
        }

        function prevStudyCard() {
            if (studyIndex > 0) {
                studyIndex--;
                showStudyCard();
            }
        }

        function nextStudyCard() {
            if (studyIndex < studyQuestions.length - 1) {
                studyIndex++;
                showStudyCard();
            }
        }

        // Map functionality
        const countryBorders = {
            'Portugal': ['Spain'],
            'Spain': ['Portugal', 'France', 'Andorra'],
            'Andorra': ['Spain', 'France'],
            'France': ['Spain', 'Andorra', 'Monaco', 'Italy', 'Switzerland', 'Germany', 'Luxembourg', 'Belgium'],
            'Monaco': ['France'],
            'Belgium': ['France', 'Luxembourg', 'Germany', 'Netherlands'],
            'Netherlands': ['Belgium', 'Germany'],
            'Luxembourg': ['France', 'Belgium', 'Germany'],
            'Germany': ['France', 'Luxembourg', 'Belgium', 'Netherlands', 'Denmark', 'Poland', 'Czech Republic', 'Austria', 'Switzerland'],
            'Switzerland': ['France', 'Germany', 'Austria', 'Liechtenstein', 'Italy'],
            'Liechtenstein': ['Switzerland', 'Austria'],
            'Austria': ['Germany', 'Czech Republic', 'Slovakia', 'Hungary', 'Slovenia', 'Italy', 'Switzerland', 'Liechtenstein'],
            'Italy': ['France', 'Switzerland', 'Austria', 'Slovenia', 'San Marino', 'Vatican City'],
            'San Marino': ['Italy'],
            'Vatican City': ['Italy'],
            'Slovenia': ['Italy', 'Austria', 'Hungary', 'Croatia'],
            'Croatia': ['Slovenia', 'Hungary', 'Serbia', 'Bosnia and Herzegovina', 'Montenegro'],
            'Bosnia and Herzegovina': ['Croatia', 'Serbia', 'Montenegro'],
            'Montenegro': ['Croatia', 'Bosnia and Herzegovina', 'Serbia', 'Kosovo', 'Albania'],
            'Albania': ['Montenegro', 'Kosovo', 'North Macedonia', 'Greece'],
            'Kosovo': ['Montenegro', 'Serbia', 'North Macedonia', 'Albania'],
            'Serbia': ['Hungary', 'Romania', 'Bulgaria', 'North Macedonia', 'Kosovo', 'Montenegro', 'Bosnia and Herzegovina', 'Croatia'],
            'North Macedonia': ['Kosovo', 'Serbia', 'Bulgaria', 'Greece', 'Albania'],
            'Greece': ['Albania', 'North Macedonia', 'Bulgaria', 'Turkey'],
            'Bulgaria': ['Serbia', 'North Macedonia', 'Greece', 'Turkey', 'Romania'],
            'Romania': ['Hungary', 'Serbia', 'Bulgaria', 'Ukraine', 'Moldova'],
            'Moldova': ['Romania', 'Ukraine'],
            'Ukraine': ['Poland', 'Slovakia', 'Hungary', 'Romania', 'Moldova', 'Belarus', 'Russia'],
            'Belarus': ['Poland', 'Lithuania', 'Latvia', 'Russia', 'Ukraine'],
            'Poland': ['Germany', 'Czech Republic', 'Slovakia', 'Ukraine', 'Belarus', 'Lithuania', 'Russia'],
            'Czech Republic': ['Germany', 'Poland', 'Slovakia', 'Austria'],
            'Czechia': ['Germany', 'Poland', 'Slovakia', 'Austria'],
            'Slovakia': ['Czech Republic', 'Poland', 'Ukraine', 'Hungary', 'Austria'],
            'Hungary': ['Austria', 'Slovakia', 'Ukraine', 'Romania', 'Serbia', 'Croatia', 'Slovenia'],
            'Denmark': ['Germany'],
            'Sweden': ['Norway', 'Finland'],
            'Norway': ['Sweden', 'Finland', 'Russia'],
            'Finland': ['Sweden', 'Norway', 'Russia'],
            'Estonia': ['Latvia', 'Russia'],
            'Latvia': ['Estonia', 'Lithuania', 'Belarus', 'Russia'],
            'Lithuania': ['Latvia', 'Belarus', 'Poland', 'Russia'],
            'Russia': ['Norway', 'Finland', 'Estonia', 'Latvia', 'Lithuania', 'Poland', 'Belarus', 'Ukraine', 'Georgia', 'Azerbaijan'],
            'Turkey': ['Greece', 'Bulgaria', 'Georgia', 'Armenia', 'Azerbaijan'],
            'Georgia': ['Russia', 'Turkey', 'Armenia', 'Azerbaijan'],
            'Armenia': ['Georgia', 'Turkey', 'Azerbaijan'],
            'Azerbaijan': ['Russia', 'Georgia', 'Armenia', 'Turkey'],
            'Cyprus': [],
            'Malta': [],
            'Iceland': [],
            'Ireland': ['United Kingdom'],
            'United Kingdom': ['Ireland'],
            'Republic of Serbia': ['Hungary', 'Romania', 'Bulgaria', 'North Macedonia', 'Kosovo', 'Montenegro', 'Bosnia and Herzegovina', 'Croatia']
        };

        // Name mappings from GeoJSON to our names
        const nameMapping = {
            'Czechia': 'Czech Republic',
            'Republic of Serbia': 'Serbia',
            'Bosnia and Herz.': 'Bosnia and Herzegovina',
            'N. Cyprus': 'Northern Cyprus',
            'Macedonia': 'North Macedonia'
        };

        let europeMap = null;
        let geoJsonLayer = null;
        let countryLayers = {};
        let selectedCountry = null;

        const defaultStyle = {
            fillColor: '#c8d6dc',
            weight: 1,
            opacity: 1,
            color: '#ffffff',
            fillOpacity: 0.8
        };

        const hoverStyle = {
            fillColor: '#a0c4cc',
            weight: 2,
            color: '#667eea',
            fillOpacity: 0.9
        };

        const selectedStyle = {
            fillColor: '#667eea',
            weight: 2,
            color: '#4c51bf',
            fillOpacity: 0.9
        };

        const neighborStyle = {
            fillColor: '#f6ad55',
            weight: 2,
            color: '#dd6b20',
            fillOpacity: 0.9
        };

        function showMapScreen() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('study-screen').classList.add('hidden');
            document.getElementById('map-screen').classList.remove('hidden');

            // Initialize map if not already done
            if (!europeMap) {
                initializeMap();
            } else {
                // Reset selection when returning to map
                resetMapSelection();
                europeMap.invalidateSize();
            }
        }

        function initializeMap() {
            // Create the map centered on Europe
            europeMap = L.map('europe-map', {
                center: [54, 15],
                zoom: 4,
                minZoom: 3,
                maxZoom: 7
            });

            // Add a simple tile layer for context (optional - can be removed for cleaner look)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(europeMap);

            // Load GeoJSON data
            loadEuropeGeoJSON();
        }

        async function loadEuropeGeoJSON() {
            try {
                // Using Natural Earth data via GitHub
                const response = await fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson');
                const data = await response.json();

                // Filter for European countries
                const europeanCountries = [
                    'Portugal', 'Spain', 'Andorra', 'France', 'Monaco', 'Belgium', 'Netherlands',
                    'Luxembourg', 'Germany', 'Switzerland', 'Liechtenstein', 'Austria', 'Italy',
                    'San Marino', 'Vatican City', 'Slovenia', 'Croatia', 'Bosnia and Herzegovina',
                    'Bosnia and Herz.', 'Montenegro', 'Albania', 'Kosovo', 'Serbia', 'Republic of Serbia',
                    'North Macedonia', 'Macedonia', 'Greece', 'Bulgaria', 'Romania', 'Moldova',
                    'Ukraine', 'Belarus', 'Poland', 'Czech Republic', 'Czechia', 'Slovakia', 'Hungary',
                    'Denmark', 'Sweden', 'Norway', 'Finland', 'Estonia', 'Latvia', 'Lithuania',
                    'Russia', 'Turkey', 'Georgia', 'Armenia', 'Azerbaijan', 'Cyprus', 'Malta',
                    'Iceland', 'Ireland', 'United Kingdom'
                ];

                const europeData = {
                    type: 'FeatureCollection',
                    features: data.features.filter(f =>
                        europeanCountries.includes(f.properties.ADMIN) ||
                        europeanCountries.includes(f.properties.name)
                    )
                };

                // Add GeoJSON layer
                geoJsonLayer = L.geoJSON(europeData, {
                    style: defaultStyle,
                    onEachFeature: onEachCountry
                }).addTo(europeMap);

            } catch (error) {
                console.error('Error loading GeoJSON:', error);
                document.getElementById('selected-country').textContent = 'Error loading map data';
            }
        }

        function onEachCountry(feature, layer) {
            const countryName = feature.properties.ADMIN || feature.properties.name;
            const normalizedName = nameMapping[countryName] || countryName;

            // Store reference to layer
            countryLayers[normalizedName] = layer;
            if (countryName !== normalizedName) {
                countryLayers[countryName] = layer;
            }

            layer.on({
                mouseover: function(e) {
                    if (normalizedName !== selectedCountry) {
                        const borders = countryBorders[normalizedName] || [];
                        if (!borders.includes(selectedCountry) && selectedCountry !== null) {
                            // Only apply hover if not a neighbor of selected
                            if (!isNeighborOfSelected(normalizedName)) {
                                layer.setStyle(hoverStyle);
                            }
                        } else if (selectedCountry === null) {
                            layer.setStyle(hoverStyle);
                        }
                    }
                },
                mouseout: function(e) {
                    if (normalizedName !== selectedCountry && !isNeighborOfSelected(normalizedName)) {
                        layer.setStyle(defaultStyle);
                    }
                },
                click: function(e) {
                    selectCountryOnMap(normalizedName);
                }
            });

            // Add tooltip with country name
            layer.bindTooltip(normalizedName, {
                permanent: false,
                direction: 'center',
                className: 'country-tooltip'
            });
        }

        function isNeighborOfSelected(countryName) {
            if (!selectedCountry) return false;
            const borders = countryBorders[selectedCountry] || [];
            return borders.includes(countryName);
        }

        function selectCountryOnMap(countryName) {
            // Reset previous selection
            resetMapSelection();

            selectedCountry = countryName;

            // Highlight selected country
            const layer = countryLayers[countryName];
            if (layer) {
                layer.setStyle(selectedStyle);
                layer.bringToFront();
            }

            // Get and highlight neighbors
            const borders = countryBorders[countryName] || [];
            borders.forEach(neighbor => {
                const neighborLayer = countryLayers[neighbor];
                if (neighborLayer) {
                    neighborLayer.setStyle(neighborStyle);
                }
            });

            // Bring selected to front again
            if (layer) {
                layer.bringToFront();
            }

            // Update info panel
            document.getElementById('selected-country').textContent = countryName;

            const borderInfo = document.getElementById('border-countries');
            if (borders.length === 0) {
                borderInfo.innerHTML = '<em>Island nation - no land borders</em>';
            } else {
                borderInfo.innerHTML = `<strong>Borders ${borders.length} ${borders.length === 1 ? 'country' : 'countries'}:</strong><br>${borders.join(', ')}`;
            }
        }

        function resetMapSelection() {
            // Reset all country styles
            Object.values(countryLayers).forEach(layer => {
                layer.setStyle(defaultStyle);
            });

            document.getElementById('selected-country').textContent = 'Select a country';
            document.getElementById('border-countries').innerHTML = '';
            selectedCountry = null;
        }
    </script>
</body>
</html>
